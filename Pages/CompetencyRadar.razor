@page "/competency-radar/{competencyType?}"
@using CompetencyApp.Data
@using CompetencyApp.Services
@inject SliderService SliderService
@inject AzureOpenAIService AzureOpenAIService
@inject AzureOpenAISettings AzureOpenAISettings
@inject IJSRuntime JSRuntime

<PageTitle>@GetPageTitle() - Radar Chart</PageTitle>

<h1>@GetPageTitle() Radar</h1>
<p class="lead">Visual representation of your competency levels across all categories</p>

@if (sliders == null || !isDataLoaded)
{
    <p><em>Loading competency data...</em></p>
}
else if (!sliders.Any())
{
    <p><em>No competency data available.</em></p>
}
else
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Competency Radar Chart</h5>
                </div>
                <div class="card-body text-center">
                    <canvas id="competencyRadar" width="600" height="600"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Legend</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6>Competency Levels</h6>
                        <div class="d-flex flex-column gap-2">
                            <div><span class="badge bg-secondary">1</span> Novice</div>
                            <div><span class="badge bg-warning">2</span> Advanced Beginner</div>
                            <div><span class="badge bg-primary">3</span> Competent</div>
                            <div><span class="badge bg-info">4</span> Proficient</div>
                            <div><span class="badge bg-success">5</span> Expert</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h6>Category Averages</h6>
                        @foreach (var categoryGroup in categoryAverages.OrderByDescending(x => x.Value))
                        {
                            var badgeColor = GetLevelBadgeColor((int)Math.Round(categoryGroup.Value));
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <small>@categoryGroup.Key:</small>
                                <span class="badge bg-@badgeColor">
                                    @categoryGroup.Value.ToString("F1")
                                </span>
                            </div>
                        }
                    </div>

                    <div class="mt-3">
                        <button class="btn btn-success btn-sm w-100" @onclick="RefreshChart">
                            <i class="oi oi-reload"></i> Refresh Chart
                        </button>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Growth Recommendations</h5>
                </div>
                <div class="card-body">
                    @if (growthAreas.Any())
                    {
                        <h6>Areas for Development:</h6>
                        <ul class="list-unstyled">
                            @foreach (var area in growthAreas.Take(3))
                            {
                                <li class="mb-2">
                                    <strong>@area.Category</strong>
                                    <br><small class="text-muted">Avg: @area.Average.ToString("F1")/5.0</small>
                                </li>
                            }
                        </ul>
                    }
                    
                    @if (strongAreas.Any())
                    {
                        <h6>Your Strengths:</h6>
                        <ul class="list-unstyled">
                            @foreach (var area in strongAreas.Take(3))
                            {
                                <li class="mb-2">
                                    <strong>@area.Category</strong>
                                    <br><small class="text-muted">Avg: @area.Average.ToString("F1")/5.0</small>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>

    @if (AzureOpenAISettings.Enabled)
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">AI-Powered Improvement Suggestions</h5>
                        <button class="btn btn-light btn-sm" @onclick="GetAISuggestions" disabled="@isLoadingSuggestions">
                            @if (isLoadingSuggestions)
                            {
                                <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
                                <span>Generating...</span>
                            }
                            else
                            {
                                <i class="oi oi-bolt"></i>
                                <span>Get AI Suggestions</span>
                            }
                        </button>
                    </div>
                    <div class="card-body">
                        @if (aiSuggestions == null || !aiSuggestions.Any())
                        {
                        <p class="text-muted mb-0">
                            <i class="oi oi-info"></i>
                            Click "Get AI Suggestions" to receive personalized recommendations for improving each competency based on your scores and notes.
                        </p>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th style="width: 20%;">Competency</th>
                                        <th style="width: 10%;" class="text-center">Score</th>
                                        <th style="width: 25%;">Your Notes</th>
                                        <th style="width: 45%;">AI Suggestion</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var categoryGroup in aiSuggestions.GroupBy(s => s.Category))
                                    {
                                        <tr class="table-secondary">
                                            <td colspan="4"><strong>@categoryGroup.Key</strong></td>
                                        </tr>
                                        @foreach (var suggestion in categoryGroup)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@suggestion.CompetencyName</strong>
                                                </td>
                                                <td class="text-center">
                                                    <span class="badge bg-@GetLevelBadgeColor(suggestion.CurrentScore) fs-6">
                                                        @suggestion.CurrentScore/5
                                                    </span>
                                                    <br>
                                                    <small class="text-muted">@suggestion.LevelName</small>
                                                </td>
                                                <td>
                                                    @if (!string.IsNullOrWhiteSpace(suggestion.UserNotes))
                                                    {
                                                        <small>@suggestion.UserNotes</small>
                                                    }
                                                    else
                                                    {
                                                        <small class="text-muted fst-italic">No notes provided</small>
                                                    }
                                                </td>
                                                <td>
                                                    <small>@suggestion.AISuggestion</small>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }
}

@code {
    [Parameter] public string? CompetencyType { get; set; } = "SE";
    
    private List<SliderModel>? sliders;
    private Dictionary<int, int> sliderValues = new();
    private Dictionary<int, string> sliderNotes = new();
    private Dictionary<string, double> categoryAverages = new();
    private List<(string Category, double Average)> growthAreas = new();
    private List<(string Category, double Average)> strongAreas = new();
    private List<CompetencySuggestion>? aiSuggestions;
    private bool isDataLoaded = false;
    private bool isLoadingSuggestions = false;
    private string? previousCompetencyType = null;
    private string VALUES_STORAGE_KEY => $"slider_values_{CompetencyType}";
    private string NOTES_STORAGE_KEY => $"slider_notes_{CompetencyType}";

    protected override async Task OnInitializedAsync()
    {
        await LoadCompetencyData();
        previousCompetencyType = CompetencyType;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (isDataLoaded && categoryAverages.Any())
        {
            // Always draw chart when data is ready and DOM is rendered
            await Task.Delay(100); // Small delay to ensure canvas is ready
            await DrawRadarChart();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Check if competency type actually changed
        if (previousCompetencyType != null && previousCompetencyType != CompetencyType)
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"Competency type changed from {previousCompetencyType} to {CompetencyType}");
            
            // Reset state for new competency type
            sliderValues.Clear();
            sliderNotes.Clear();
            categoryAverages.Clear();
            growthAreas.Clear();
            strongAreas.Clear();
            aiSuggestions = null;
            isDataLoaded = false;
            
            // Load new data
            await LoadCompetencyData();
            previousCompetencyType = CompetencyType;
            
            StateHasChanged();
        }
    }

    private async Task LoadCompetencyData()
    {
        sliders = await SliderService.GetSlidersAsync(CompetencyType ?? "SE");
        
        if (sliders != null)
        {
            await LoadDataFromStorage();
            CalculateCategoryAverages();
            isDataLoaded = true;
        }
    }

    private string GetPageTitle()
    {
        var displayName = SliderService.GetCompetencyDisplayName(CompetencyType ?? "SE");
        return $"{displayName} Competency";
    }

    private async Task LoadDataFromStorage()
    {
        try
        {
            var savedValues = await JSRuntime.InvokeAsync<string>("localStorageHelper.getItem", VALUES_STORAGE_KEY);
            if (!string.IsNullOrEmpty(savedValues))
            {
                var storedValues = System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, int>>(savedValues);
                if (storedValues != null)
                {
                    sliderValues = storedValues;
                }
            }

            // Load notes
            var savedNotes = await JSRuntime.InvokeAsync<string>("localStorageHelper.getCompetencyNotes");
            if (!string.IsNullOrEmpty(savedNotes))
            {
                var storedNotes = System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, string>>(savedNotes);
                if (storedNotes != null)
                {
                    sliderNotes = storedNotes;
                }
            }
            
            // Set defaults for missing values
            foreach (var slider in sliders!)
            {
                if (!sliderValues.ContainsKey(slider.Id))
                {
                    sliderValues[slider.Id] = slider.DefaultValue;
                }
                if (!sliderNotes.ContainsKey(slider.Id))
                {
                    sliderNotes[slider.Id] = string.Empty;
                }
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error loading data:", ex.Message);
            
            // Fallback to defaults
            foreach (var slider in sliders!)
            {
                sliderValues[slider.Id] = slider.DefaultValue;
                sliderNotes[slider.Id] = string.Empty;
            }
        }
    }

    private void CalculateCategoryAverages()
    {
        if (sliders == null) return;

        categoryAverages = sliders
            .GroupBy(s => s.Category)
            .ToDictionary(
                g => g.Key,
                g => g.Average(s => sliderValues.GetValueOrDefault(s.Id, s.DefaultValue))
            );

        growthAreas = categoryAverages
            .OrderBy(x => x.Value)
            .Select(x => (x.Key, x.Value))
            .Where(x => x.Value < 3.5)
            .ToList();

        strongAreas = categoryAverages
            .OrderByDescending(x => x.Value)
            .Select(x => (x.Key, x.Value))
            .Where(x => x.Value >= 3.5)
            .ToList();
    }

    private async Task DrawRadarChart()
    {
        try
        {
            // Ensure we have data to draw
            if (!categoryAverages.Any())
            {
                await JSRuntime.InvokeVoidAsync("console.warn", "No category data available for radar chart");
                return;
            }

            var categories = categoryAverages.Keys.ToArray();
            var values = categoryAverages.Values.ToArray();

            var chartData = new
            {
                categories = categories,
                values = values,
                colors = new
                {
                    line = "#007bff",
                    fill = "rgba(0, 123, 255, 0.2)",
                    point = "#007bff",
                    grid = "#e9ecef"
                }
            };

            await JSRuntime.InvokeVoidAsync("drawRadarChart", "competencyRadar", chartData);
            await JSRuntime.InvokeVoidAsync("console.log", "Radar chart drawn successfully");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error drawing radar chart:", ex.Message);
        }
    }

    private async Task RefreshChart()
    {
        await LoadDataFromStorage();
        CalculateCategoryAverages();
        StateHasChanged();
        
        // Add small delay to ensure UI updates before drawing
        await Task.Delay(50);
        await DrawRadarChart();
    }

    private string GetLevelBadgeColor(int level)
    {
        return level switch
        {
            1 => "secondary",
            2 => "warning", 
            3 => "primary",
            4 => "info",
            5 => "success",
            _ => "secondary"
        };
    }

    private async Task GetAISuggestions()
    {
        if (sliders == null || !sliders.Any())
        {
            return;
        }

        isLoadingSuggestions = true;
        StateHasChanged();

        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", "Generating AI suggestions...");
            
            aiSuggestions = await AzureOpenAIService.GetCompetencySuggestionsAsync(
                sliders,
                sliderValues,
                sliderNotes);
            
            await JSRuntime.InvokeVoidAsync("console.log", $"Generated {aiSuggestions.Count} suggestions");
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", "Error getting AI suggestions:", ex.Message);
        }
        finally
        {
            isLoadingSuggestions = false;
            StateHasChanged();
        }
    }
}